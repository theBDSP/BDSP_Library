#pragma once


constexpr int BDSP_BIT_CRUSH_MIN_DEPTH = 1;
constexpr int BDSP_BIT_CRUSH_MAX_DEPTH = 16;

namespace bdsp
{
	namespace dsp
	{
		namespace DistortionTypes
		{
			static const double BitCrushCompensationData[] = { 0.577086,0.57658,0.576336,0.574798,0.577641,0.576889,0.575915,0.580954,0.576741,0.578846,0.582214,0.575801,0.579919,0.577294,0.576482,0.580376,0.575803,0.578744,0.576983,0.57756,0.574818,0.578416,0.577613,0.578764,0.576382,0.579642,0.578022,0.574829,0.577355,0.580131,0.577207,0.579593,0.577313,0.577131,0.577762,0.576844,0.578065,0.572417,0.578057,0.577305,0.580398,0.574152,0.577453,0.577714,0.578448,0.576012,0.57693,0.577734,0.57632,0.575164,0.579867,0.577361,0.578783,0.575309,0.578467,0.577868,0.576019,0.579505,0.575634,0.580201,0.577309,0.576222,0.578131,0.581365,0.575426,0.577283,0.574959,0.579038,0.574515,0.580432,0.578529,0.576541,0.578998,0.575321,0.575429,0.579782,0.57392,0.576966,0.577263,0.574631,0.575821,0.576958,0.576412,0.578341,0.577696,0.578113,0.579111,0.578125,0.583706,0.580844,0.58037,0.584219,0.579339,0.584176,0.584895,0.584719,0.590464,0.602841,0.619857,0.644424,0.66946 };
			static const unsigned char BitCrushPathData[] = { 110,109,0,0,128,191,194,195,135,63,108,164,112,125,191,194,195,135,63,108,72,225,122,191,194,195,135,63,108,236,81,120,191,194,195,135,63,108,144,194,117,191,194,195,135,63,108,52,51,115,191,194,195,135,63,108,216,163,112,191,194,195,135,63,108,124,20, 110,191,194,195,135,63,108,32,133,107,191,194,195,135,63,108,196,245,104,191,194,195,135,63,108,104,102,102,191,194,195,135,63,108,12,215,99,191,194,195,135,63,108,176,71,97,191,3,5,53,63,108,84,184,94,191,3,5,53,63,108,248,40,92,191,3,5,53,63,108,156, 153,89,191,3,5,53,63,108,64,10,87,191,3,5,53,63,108,228,122,84,191,3,5,53,63,108,136,235,81,191,3,5,53,63,108,44,92,79,191,3,5,53,63,108,208,204,76,191,3,5,53,63,108,116,61,74,191,3,5,53,63,108,24,174,71,191,3,5,53,63,108,188,30,69,191,3,5,53,63,108, 96,143,66,191,3,5,53,63,108,4,0,64,191,3,5,53,63,108,168,112,61,191,3,5,53,63,108,76,225,58,191,3,5,53,63,108,240,81,56,191,3,5,53,63,108,148,194,53,191,3,5,53,63,108,56,51,51,191,3,5,53,63,108,220,163,48,191,3,5,53,63,108,128,20,46,191,3,5,53,63,108, 36,133,43,191,3,5,53,63,108,200,245,40,191,3,5,53,63,108,108,102,38,191,3,5,53,63,108,16,215,35,191,3,5,53,63,108,180,71,33,191,3,5,53,63,108,88,184,30,191,3,5,53,63,108,252,40,28,191,3,5,53,63,108,160,153,25,191,3,5,53,63,108,68,10,23,191,3,5,53,63, 108,232,122,20,191,3,5,53,63,108,140,235,17,191,3,5,53,63,108,48,92,15,191,3,5,53,63,108,212,204,12,191,3,5,53,63,108,120,61,10,191,3,5,53,63,108,28,174,7,191,3,5,181,62,108,192,30,5,191,3,5,181,62,108,100,143,2,191,3,5,181,62,108,8,0,0,191,3,5,181,62, 108,88,225,250,190,3,5,181,62,108,160,194,245,190,3,5,181,62,108,232,163,240,190,3,5,181,62,108,48,133,235,190,3,5,181,62,108,120,102,230,190,3,5,181,62,108,192,71,225,190,3,5,181,62,108,8,41,220,190,3,5,181,62,108,80,10,215,190,3,5,181,62,108,152,235, 209,190,3,5,181,62,108,224,204,204,190,3,5,181,62,108,40,174,199,190,3,5,181,62,108,112,143,194,190,3,5,181,62,108,184,112,189,190,3,5,181,62,108,0,82,184,190,3,5,181,62,108,72,51,179,190,3,5,181,62,108,144,20,174,190,3,5,181,62,108,216,245,168,190,3, 5,181,62,108,32,215,163,190,3,5,181,62,108,104,184,158,190,3,5,181,62,108,176,153,153,190,3,5,181,62,108,248,122,148,190,3,5,181,62,108,64,92,143,190,3,5,181,62,108,136,61,138,190,3,5,181,62,108,208,30,133,190,3,5,181,62,108,24,0,128,190,3,5,181,62,108, 191,194,117,190,3,5,181,62,108,78,133,107,190,3,5,181,62,108,221,71,97,190,3,5,181,62,108,108,10,87,190,3,5,181,62,108,251,204,76,190,3,5,181,62,108,138,143,66,190,3,5,181,62,108,25,82,56,190,3,5,181,62,108,168,20,46,190,0,0,0,0,108,55,215,35,190,0,0, 0,0,108,198,153,25,190,0,0,0,0,108,85,92,15,190,0,0,0,0,108,228,30,5,190,0,0,0,0,108,231,194,245,189,0,0,0,0,108,6,72,225,189,0,0,0,0,108,37,205,204,189,0,0,0,0,108,68,82,184,189,0,0,0,0,108,99,215,163,189,0,0,0,0,108,130,92,143,189,0,0,0,0,108,65,195, 117,189,0,0,0,0,108,126,205,76,189,0,0,0,0,108,187,215,35,189,0,0,0,0,108,241,195,245,188,0,0,0,0,108,108,216,163,188,0,0,0,0,108,206,217,35,188,0,0,0,0,108,164,240,48,181,0,0,0,0,108,70,212,35,60,0,0,0,128,108,168,213,163,60,0,0,0,128,108,45,193,245, 60,0,0,0,128,108,89,214,35,61,0,0,0,128,108,28,204,76,61,0,0,0,128,108,223,193,117,61,0,0,0,128,108,209,91,143,61,0,0,0,128,108,178,214,163,61,0,0,0,128,108,147,81,184,61,0,0,0,128,108,116,204,204,61,0,0,0,128,108,85,71,225,61,0,0,0,128,108,54,194,245, 61,0,0,0,128,108,140,30,5,62,0,0,0,128,108,253,91,15,62,0,0,0,128,108,110,153,25,62,0,0,0,128,108,223,214,35,62,0,0,0,128,108,80,20,46,62,0,0,0,128,108,193,81,56,62,3,5,181,190,108,50,143,66,62,3,5,181,190,108,163,204,76,62,3,5,181,190,108,20,10,87,62, 3,5,181,190,108,133,71,97,62,3,5,181,190,108,246,132,107,62,3,5,181,190,108,103,194,117,62,3,5,181,190,108,216,255,127,62,3,5,181,190,108,164,30,133,62,3,5,181,190,108,92,61,138,62,3,5,181,190,108,20,92,143,62,3,5,181,190,108,204,122,148,62,3,5,181,190, 108,132,153,153,62,3,5,181,190,108,60,184,158,62,3,5,181,190,108,244,214,163,62,3,5,181,190,108,172,245,168,62,3,5,181,190,108,100,20,174,62,3,5,181,190,108,28,51,179,62,3,5,181,190,108,212,81,184,62,3,5,181,190,108,140,112,189,62,3,5,181,190,108,68, 143,194,62,3,5,181,190,108,252,173,199,62,3,5,181,190,108,180,204,204,62,3,5,181,190,108,108,235,209,62,3,5,181,190,108,36,10,215,62,3,5,181,190,108,220,40,220,62,3,5,181,190,108,148,71,225,62,3,5,181,190,108,76,102,230,62,3,5,181,190,108,4,133,235,62, 3,5,181,190,108,188,163,240,62,3,5,181,190,108,116,194,245,62,3,5,181,190,108,44,225,250,62,3,5,181,190,108,228,255,255,62,3,5,181,190,108,78,143,2,63,3,5,181,190,108,170,30,5,63,3,5,181,190,108,6,174,7,63,3,5,181,190,108,98,61,10,63,3,5,53,191,108,190, 204,12,63,3,5,53,191,108,26,92,15,63,3,5,53,191,108,118,235,17,63,3,5,53,191,108,210,122,20,63,3,5,53,191,108,46,10,23,63,3,5,53,191,108,138,153,25,63,3,5,53,191,108,230,40,28,63,3,5,53,191,108,66,184,30,63,3,5,53,191,108,158,71,33,63,3,5,53,191,108, 250,214,35,63,3,5,53,191,108,86,102,38,63,3,5,53,191,108,178,245,40,63,3,5,53,191,108,14,133,43,63,3,5,53,191,108,106,20,46,63,3,5,53,191,108,198,163,48,63,3,5,53,191,108,34,51,51,63,3,5,53,191,108,126,194,53,63,3,5,53,191,108,218,81,56,63,3,5,53,191, 108,54,225,58,63,3,5,53,191,108,146,112,61,63,3,5,53,191,108,238,255,63,63,3,5,53,191,108,74,143,66,63,3,5,53,191,108,166,30,69,63,3,5,53,191,108,2,174,71,63,3,5,53,191,108,94,61,74,63,3,5,53,191,108,186,204,76,63,3,5,53,191,108,22,92,79,63,3,5,53,191, 108,114,235,81,63,3,5,53,191,108,206,122,84,63,3,5,53,191,108,42,10,87,63,3,5,53,191,108,134,153,89,63,3,5,53,191,108,226,40,92,63,3,5,53,191,108,62,184,94,63,3,5,53,191,108,154,71,97,63,3,5,53,191,108,246,214,99,63,194,195,135,191,108,82,102,102,63, 194,195,135,191,108,174,245,104,63,194,195,135,191,108,10,133,107,63,194,195,135,191,108,102,20,110,63,194,195,135,191,108,194,163,112,63,194,195,135,191,108,30,51,115,63,194,195,135,191,108,122,194,117,63,194,195,135,191,108,214,81,120,63,194,195,135, 191,108,50,225,122,63,194,195,135,191,108,142,112,125,63,194,195,135,191,108,234,255,127,63,194,195,135,191,101,0,0 };
			/**
			 * Standard bit crush. Distortion amount reduces bit depth.
			 * https://www.desmos.com/calculator/fauh34su8i
			 */
			template<typename T>
			struct BitCrush : public DistortionTypeBase<T>
			{
				BitCrush()
					:DistortionTypeBase<T>(BitCrushCompensationData, std::size(BitCrushCompensationData), BitCrushPathData, sizeof(BitCrushPathData))
				{
				}

				T processSample(T in, T amt, bool isScaled) override
				{
					T bitDepth = juce::jmap(amt, (T)BDSP_BIT_CRUSH_MAX_DEPTH, (T)BDSP_BIT_CRUSH_MIN_DEPTH);
					return  round(in * pow(2, bitDepth - 1)) / pow(2, bitDepth - 1) * (isScaled ? DistortionTypeBase<T>::CompensationGain.processSample(amt) : 1);
				}

				inline static const juce::String Name{ "Bit Crush" };
			};

		}

	} //namespace dsp
} //namespace bdsp
